<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    />

    <link th:href="@{/css/style.css}" rel="stylesheet" />
    <link th:href="@{/css/main.css}" rel="stylesheet" />
    <!--Toast-->
    <link rel="stylesheet" th:href="@{/css/toast.min.css}" />
    <style>
      /* body {
            margin: 40px 10px;
            padding: 0;
            font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
            font-size: 14px;
        } */

      #calendar {
        max-width: 1100px;
        margin: 0 auto;
      }
    </style>
  </head>

  <body>
    <div class="wrapper d-flex align-items-stretch">
      <div th:insert="~{fragments/sidebar :: sidebar}"></div>

      <!-- Page Content  -->
      <div id="content" class="p-1 p-md-2">
        <div th:insert="~{fragments/header :: header}"></div>
        <div id="calendar"></div>
      </div>
    </div>
    <div id="modal-register" class="modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Registrar cita</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form th:action="@{/citas/guardar}" method="post" th:object="${cita}">
              <div class="form-row">
                <div class="form-group col-lg-12">
                  <label for="message-text" class="col-form-label">
                    Título:
                  </label>
                  <input
                    type="text"
                    class="form-control"
                    id="title"
                    placeholder="Título"
                    th:field="*{title}"
                  />
                </div>
                <div class="form-group col-lg-6">
                  <label for="recipient-name" class="col-form-label">
                    Fecha inicio:
                  </label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="fechaInicio"
                    th:field="*{start}"
                  />
                </div>
                <div class="form-group col-lg-6">
                  <label for="message-text" class="col-form-label">
                    Fecha fin:
                  </label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="fechaFin"
                    th:field="*{end}"
                  />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group col">
									<label>Servicio:</label>
									<select class="form-control form-control" th:field="*{servicio.id}">
										<option hidden selected value="">Selecciona un servicio...</option>
										<option th:each="tmpServicio: ${listaServicios}" th:value="${tmpServicio.id}" th:text="${tmpServicio.nombre}">

										</option>
									</select>
								</div>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-dismiss="modal"
                >
                  Cancelar
                </button>
                <button type="submit" class="btn btn-primary">Guardar</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div id="modal-details" class="modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Detalles de la cita</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
              <div class="form-row">
                <div class="form-group col-lg-12">
                  <label for="message-text" class="col-form-label">
                    Título:
                  </label>
                  <input
                    type="text"
                    class="form-control"
                    id="title-details"
                    placeholder="Título"
                    disabled
                  />
                </div>
                <div class="form-group col-lg-6">
                  <label for="recipient-name" class="col-form-label">
                    Fecha inicio:
                  </label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="start-details"
                    disabled
                  />
                </div>
                <div class="form-group col-lg-6">
                  <label for="message-text" class="col-form-label">
                    Fecha fin:
                  </label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="end-details"
                    disabled
                  />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group col">
									<label>Servicio:</label>
									<input
                    type="text"
                    class="form-control"
                    id="servicio-details"
                    placeholder="Servicio"
                    disabled
                  />
								</div>
              </div>
              <div class="form-row">
                <div class="form-group col">
									<label>Ventanilla:</label>
									<input
                    type="text"
                    class="form-control"
                    id="ventanilla-details"
                    placeholder="Ventanilla"
                    disabled
                  />
								</div>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-dismiss="modal"
                >
                  Cerrar
                </button>
              </div>
            </div>
        </div>
      </div>
    </div>
    <input th:value="${isRegistrer}==null ? 'sinRegistro' : ${isRegistrer} " id="mensajeRegistro" hidden="hidden"/>


    <script th:src="@{/js/main.js}"></script>
    <script th:src="@{/js/bootstrap/jquery.min.js}"></script>
    <script th:src="@{/js/bootstrap/popper.js}"></script>
    <script th:src="@{/js/bootstrap/bootstrap.min.js}"></script>
    <script th:src="@{/js/bootstrap/main.js}"></script>
    <!--Toast-->
	  <script th:src="@{/js/toast.min.js}"></script>
    <script th:if="${msg_success != null}">
      new Toast({
        message: '[[${msg_success}]]',
        type: 'success'
      });
    </script>
    <script th:if="${msg_error != null}">
      new Toast({
        message: '[[${msg_error}]]',
        type: 'danger'
      });
    </script>
    <script>
      const citas = [];
      document.body.onload = async () => {
        try {
          const response = await fetch("/citas/");
          const data = await response.json();
          data.map((cita) => {
            //validar status
            citas.push({
              id: cita.id,
              title: cita.title,
              start: cita.start,
              end: cita.end,
              color: "#00a65a",
              item: cita,
            });
          });
          calendarRender(citas);
          console.log(citas);
        } catch (error) {
          console.log(error);
        }
      };

      const calendarRender = (citas) => {
        console.log(citas);
        var calendarEl = document.getElementById("calendar");
        var calendar = new FullCalendar.Calendar(calendarEl, {
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "timeGridWeek,timeGridDay,listWeek",
          },
          initialView: "timeGridWeek",
          initialDate: new Date(),
          navLinks: true, // can click day/week names to navigate views
          selectable: true,
          nowIndicator: true,
          allDaySlot: false,
          selectMirror: true,
          timeZone: "America/Mexico_City",
          locale: "es",
          hiddenDays: [0, 6],
          slotMaxTime: "18:00",
          slotMinTime: "08:00",
          validRange: {
            start: new Date()
          },
          select: function (args) {
            let date = new Date();
            let dateif = new Date(args.startStr);
            console.log(dateif)
            if (dateif < date) {
              alert("No se puede seleccionar una fecha pasada");
              return;
            }
            console.log("args: ",args);
            let start = args.startStr;
            let end = args.endStr;
            $("#fechaInicio").val(start);
            $("#fechaFin").val(end);
            $("#modal-register").modal("show");
            // var title = prompt('Event Title:');
          },
          eventClick: function (args) {
              console.log(args);
              let start = args.event._def.extendedProps.item.start;
              let end = args.event._def.extendedProps.item.end;
              let title = args.event._def.extendedProps.item.title;
              let servicio = args.event._def.extendedProps.item.servicio.nombre;
              let ventanilla = args.event._def.extendedProps.item.ventanilla.nombre;
              // console.log("start: ", start.replace(' ' ,'T'))
              $("#modal-details").modal("show");
              $("#title-details").val(title);
              $("#start-details").val(start.replace(' ' ,'T'));
              $("#end-details").val(end.replace(' ' ,'T'));
              $("#servicio-details").val(servicio);
              $("#ventanilla-details").val(ventanilla);
          },
          editable: false,
          dayMaxEvents: true, // allow "more" link when too many events
          events: citas,
        });
        calendar.render();
      };
    </script>
  </body>
</html>
